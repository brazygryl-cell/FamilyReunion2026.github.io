<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Forum</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .forum-tab { padding: 10px 16px; border-radius: 6px; cursor: pointer; background:#eee; }
    .forum-tab.active { background:#333; color:white; }

    #posts { max-width:800px; margin:auto; margin-top:20px; }
    .post { background:white; border-radius:6px; padding:12px; margin-bottom:14px; border:1px solid #ddd; }
    .meta { font-size:0.8em; color:#666; margin-top:6px; display:block; }

    #postBox { max-width:800px; margin:auto; margin-top:25px; }
    textarea {
      width:100%;
      height:120px;
      padding:10px;
      border-radius:6px;
      border:1px solid #bbb;
      background:white;
      color:black;
    }
    #submitPost { margin-top:10px; padding:8px 14px; border-radius:6px; cursor:pointer; }
    .status-message { margin-top:12px; text-align:center; font-size:0.95em; }
    .status-message.error { color:#b00020; }
    .status-message.success { color:#0f5132; }
    .status-message.info { color:#0d6efd; }
  </style>

</head>
<body>
<header></header>

<section class="section">
  <div class="container">

    <h2>Family Forum</h2>
    <p>Talk, plan, and share updates.</p>

    <!-- Post box -->
    <form
      id="forumForm"
      name="forum-post"
      method="POST"
      data-netlify="true"
      netlify-honeypot="bot-field"
      novalidate
    >
      <input type="hidden" name="form-name" value="forum-post" />
      <p class="sr-only" hidden>
        <label>Don’t fill this out if you're human: <input name="bot-field" /></label>
      </p>
      <input type="hidden" name="email" id="postEmail" value="" />
      <textarea
        id="postBody"
        name="message"
        placeholder="Write your message..."
      ></textarea>
      <button id="submitPost" type="submit">Post</button>
    </form>

    <p id="postStatus" class="status-message"></p>

    <!-- Posts -->
    <div id="posts">No posts yet.</div>

  </div>
</section>

<footer></footer>

<script>
const API = "/.netlify/functions/forum";
const postsContainer = document.getElementById("posts");
const statusMessage = document.getElementById("postStatus");
const submitButton = document.getElementById("submitPost");
const postField = document.getElementById("postBody");
const postEmailField = document.getElementById("postEmail");
const form = document.getElementById("forumForm");

function showStatus(message = "", type = "") {
  if (!statusMessage) return;
  statusMessage.textContent = message;
  statusMessage.className = `status-message${type ? " " + type : ""}`;
}

async function loadPosts() {
  try {
    const response = await fetch(API, { method: "GET" });
    const data = await response.json().catch(() => []);

    if (!response.ok) {
      const message = (data && data.error) || response.statusText;
      throw new Error(message || "Unable to load posts");
    }

    const posts = Array.isArray(data) ? data : [];
    postsContainer.innerHTML = posts.length ? "" : "No posts yet.";

    posts.forEach((post) => {
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <p>${post.body}</p>
        <span class="meta">— ${post.by}, ${new Date(post.createdAt).toLocaleString()}</span>
      `;
      postsContainer.appendChild(div);
    });
  } catch (err) {
    console.error("Failed to load posts:", err);
    showStatus(`Could not load posts: ${err.message}`, "error");
  }
}

form.addEventListener("submit", async (event) => {
  event.preventDefault();
  const body = postField.value.trim();
  if (!body) {
    showStatus("Please write something before posting.", "info");
    return;
  }

  const user = window.netlifyIdentity && window.netlifyIdentity.currentUser();
  const email = user ? user.email : "anonymous";
  if (postEmailField) {
    postEmailField.value = email;
  }

  try {
    submitButton.disabled = true;
    showStatus("Saving your post...", "info");

    const response = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ body, email }),
    });

    const data = await response.json().catch(() => ({}));
    if (!response.ok) {
      const message = data.details || data.error || response.statusText;
      throw new Error(message || "Unable to save post");
    }

    postField.value = "";
    showStatus("Post published!", "success");
    loadPosts();
  } catch (err) {
    console.error("Failed to submit post:", err);
    showStatus(`Could not submit your post: ${err.message}`, "error");
  } finally {
    submitButton.disabled = false;
  }
});

loadPosts();
</script>

<script type="module">
  import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

  document.addEventListener("DOMContentLoaded", () => {
    if (!window.location.pathname.includes("login.html")) {
      requireAuth();
    }

    loadNavbar();
    enableLogout();
  });
</script>


</body>
</html>
