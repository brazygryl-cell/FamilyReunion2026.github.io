<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Forum — Williams Reunion 2026</title>

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ----- Layout ----- */
.forum-container {
  max-width: 850px;
  margin: 2rem auto;
  padding: 1rem;
}
.forum-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 1rem;
}
.forum-tab {
  padding: 8px 14px;
  border-radius: 8px;
  background: #1c1f29;
  cursor: pointer;
  border: 1px solid var(--border);
}
.forum-tab.active {
  background: var(--mint);
  color: #0d1412;
  font-weight: 600;
}
.post {
  background: #14171f;
  border: 1px solid var(--border);
  padding: 1rem;
  border-radius: 10px;
  margin-bottom: 1rem;
}
.meta {
  color: var(--muted);
  margin-bottom: 6px;
}
.new-post-box {
  margin-top: 2rem;
  padding: 1rem;
  border-radius: 10px;
  background: #11141b;
}
textarea {
  width: 100%;
  min-height: 90px;
  resize: vertical;
  padding: 10px;
  border-radius: 8px;
  background: #0f1218;
  color: var(--text);
  border: 1px solid var(--border);
}
button {
  margin-top: 10px;
  width: 100%;
  padding: 10px;
  background: var(--mint);
  color: #07100d;
  border-radius: 8px;
  font-weight: 600;
}
</style>
</head>

<body>
<header></header>

<div class="forum-container">
  <h1>Family Forum</h1>
  <p style="color:var(--muted)">Share announcements, questions, and love 💚</p>

  <!-- TABS -->
  <div class="forum-tabs">
    <div class="forum-tab active" data-board="general">General</div>
    <div class="forum-tab" data-board="travel">Travel</div>
    <div class="forum-tab" data-board="lodging">Lodging</div>
  </div>

  <!-- Posts -->
  <div id="posts"></div>

  <!-- Create Post -->
  <div class="new-post-box">
    <select id="postBoard">
      <option value="general">General</option>
      <option value="travel">Travel</option>
      <option value="lodging">Lodging</option>
    </select>

    <textarea id="postBody" placeholder="Write a message…"></textarea>
    <button id="submitPost">Post</button>
  </div>
</div>

<footer></footer>

<!-- 🔐 Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

/* netlify-scan: ignore */
const firebaseConfig = {
  apiKey: "AIzaSyAldYSp37LZO31XkGc4F1xhnQ9bpBXLU6Q",
  authDomain: "williams-reunion.firebaseapp.com",
  projectId: "williams-reunion"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

requireAuth();
document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  enableLogout();
});

// Wait until user is logged in before loading forum
onAuthStateChanged(auth, (user) => {
  if (!user) return;
  loadPosts("general");
});

const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const boardSelect = document.getElementById("postBoard");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

function loadPosts(board) {
  postsEl.innerHTML = "<p style='color:#888;'>Loading…</p>";

  const ref = collection(db, `forum_${board}`);
  const q = query(ref, orderBy("createdAt", "desc"));

  onSnapshot(q, (snapshot) => {
    postsEl.innerHTML = "";
    if (snapshot.empty) return postsEl.innerHTML = "<p style='color:#666;'>No posts yet.</p>";

    snapshot.forEach((doc) => {
      const p = doc.data();
      postsEl.innerHTML += `
        <div class="post">
          <div class="meta">${p.by || "Unknown"} • ${p.createdAt?.toDate().toLocaleString() || ""}</div>
          <p>${p.body}</p>
        </div>`;
    });
  });
}

tabs.forEach((tab) => {
  tab.addEventListener("click", () => {
    tabs.forEach((x) => x.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    boardSelect.value = currentBoard;
    loadPosts(currentBoard);
  });
});

postBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  const user = auth.currentUser;
  if (!text) return;
  if (!user) return alert("Login required.");

  await addDoc(collection(db, `forum_${currentBoard}`), {
    body: text,
    by: user.email,
    createdAt: serverTimestamp(),
  });

  textarea.value = "";
});
</script>

</body>
</html>

