<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Forum - Williams Reunion</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Family Forum</h1>

  <nav class="forum-nav">
    <a href="forum-general.html">General</a> |
    <a href="forum-memories.html">Pictures</a> |
    <a href="forum-planning.html">Need help planning?</a>
  </nav>

  <button id="logout">Logout</button>

  <div id="messages" class="forum-messages"></div>

  <form id="message-form">
    <textarea id="message" placeholder="Write a message..." required></textarea>
    <button type="submit">Post</button>
  </form>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>

  <script>
    // ðŸ”’ Auth guard
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const approvedDoc = await db.collection('approvedUsers').doc(user.email).get();
      if (!approvedDoc.exists || !approvedDoc.data().approved) {
        await auth.signOut();
        alert("Your account has not been approved yet.");
        window.location.href = "login.html";
      }
    });

    // ðŸšª Logout
    document.getElementById('logout').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = "login.html";
    });

    // ðŸ’¬ Message posting
    const form = document.getElementById('message-form');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const text = document.getElementById('message').value.trim();
      const user = auth.currentUser;
      if (!text || !user) return;

      await db.collection('forumMessages').add({
        text,
        user: user.email,
        timestamp: new Date()
      });

      document.getElementById('message').value = '';
    });

    // ðŸ§¾ Display messages
    db.collection('forumMessages')
      .orderBy('timestamp', 'asc')
      .onSnapshot(snapshot => {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('message');
          div.innerHTML = `<strong>${msg.user}</strong>: ${msg.text}`;
          container.appendChild(div);
        });
      });
  </script>
</body>
</html>

