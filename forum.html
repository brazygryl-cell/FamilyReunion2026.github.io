<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

import { loadNavbar, enableLogout, ensureLoggedIn } from "./nav.js";

document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  enableLogout();
  ensureLoggedIn();
});

// ✅ Use front-end Firebase keys (safe, public keys are meant to be public)
const firebaseConfig = {
 apiKey: "YOUR_WEB_API_KEY",
 authDomain: "williams-reunion.firebaseapp.com",
 projectId: "williams-reunion",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ---- UI elements ----
const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const boardSelect = document.getElementById("postBoard");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

// ✅ Load posts live from Firestore
function loadPosts(board) {
  postsEl.innerHTML = `<p style="color:#aaa;text-align:center;">Loading...</p>`;

  const ref = collection(db, `forum_${board}`);
  const q = query(ref, orderBy("createdAt", "desc"));

  onSnapshot(q, (snapshot) => {
    postsEl.innerHTML = "";
    if (snapshot.empty) return (postsEl.innerHTML = `<p>No posts yet.</p>`);

    snapshot.forEach((doc) => {
      const p = doc.data();
      postsEl.innerHTML += `
        <div class="post">
          <div class="meta">${p.by || "Someone"} • ${p.createdAt?.toDate().toLocaleString() || ""}</div>
          <p>${p.body}</p>
        </div>
      `;
    });
  });
}

// ✅ Switch tabs
tabs.forEach((tab) => {
  tab.addEventListener("click", () => {
    tabs.forEach((t) => t.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    boardSelect.value = currentBoard;
    loadPosts(currentBoard);
  });
});

// ✅ Create post
postBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  const user = auth.currentUser;
  if (!text) return;
  if (!user) return alert("Login required.");

  const ref = collection(db, `forum_${boardSelect.value}`);

  await addDoc(ref, {
    body: text,
    by: user.email,
    createdAt: serverTimestamp(),
  });

  textarea.value = "";
});

loadPosts(currentBoard);
</script>
