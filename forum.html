<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Forum â€” Williams Family Reunion</title>

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
/* ðŸŒ™ Discord-Inspired Forum Styling */
.tabs-container {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 1.5rem;
}

.forum-tab {
  padding: 8px 16px;
  background: #232428;
  border: 1px solid #3a3c42;
  border-radius: 8px;
  cursor: pointer;
  color: #cfcfcf;
  font-weight: 500;
  transition: 0.2s;
}
.forum-tab.active, .forum-tab:hover {
  background: #5865F2;
  border-color: #5865F2;
  color: white;
}

#posts {
  max-width: 750px;
  margin: 1rem auto;
  padding: 1rem;
}

.post {
  background: #2b2d31;
  border: 1px solid #3a3c42;
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 14px;
}
.post:hover { border-color: #5865F2; }

.meta {
  font-size: 0.85rem;
  color: #9ca3af;
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
}
.meta-name { font-weight: 600; color: #e1e1e1; }
.meta-time { font-size: 0.75rem; color: #8b8b8b; }

.post p { color: #dcdcdc; margin: 0; }

#postBox {
  max-width: 750px;
  margin: 2rem auto;
  padding: 1rem;
  background: #1e1f22;
  border: 1px solid #3a3c42;
  border-radius: 12px;
}
#postBody {
  width: 100%;
  background: #2b2d31;
  border: 1px solid #3a3c42;
  padding: 12px;
  color: white;
  min-height: 80px;
  border-radius: 8px;
  resize: vertical;
}
#submitPost {
  width: 100%;
  background: #5865F2;
  border: none;
  padding: 12px;
  color: white;
  cursor: pointer;
  border-radius: 8px;
  margin-top: 8px;
  font-weight: 600;
}
#submitPost:hover { background: #4752C4; }
</style>
</head>

<body>
<header></header>

<h2 style="text-align:center;margin-top:1.5rem;">Family Forum ðŸ’¬</h2>

<div class="tabs-container">
  <div class="forum-tab active" data-board="general">General</div>
  <div class="forum-tab" data-board="memories">Memories</div>
  <div class="forum-tab" data-board="planning">Planning</div>
</div>

<div id="posts"></div>

<div id="postBox">
  <select id="postBoard">
    <option value="general">General</option>
    <option value="memories">Memories</option>
    <option value="planning">Planning</option>
  </select>
  <textarea id="postBody" placeholder="Say something..."></textarea>
  <button id="submitPost">Post</button>
</div>

<footer></footer>

<!-- âœ… Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- âœ… Make env.js load FIRST -->
<script src="env.js"></script>

<!-- âœ… Firebase + Forum Logic -->
<script type="module">
import { loadNavbar, enableLogout, requireAuth } from "./nav.js";
import getFirebaseConfig from "./firebase-config.public.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  enableLogout();
  requireAuth();
});

const firebaseConfig = getFirebaseConfig();
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Elements
const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const boardSelect = document.getElementById("postBoard");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

// âœ… Load posts
function loadPosts(board) {
  postsEl.innerHTML = `<p style="text-align:center;color:#bbb;">Loading...</p>`;

  const q = query(collection(db, `forum_${board}`), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    postsEl.innerHTML = "";
    if (snapshot.empty) return postsEl.innerHTML = `<p style="text-align:center;color:#777;">No posts yet.</p>`;
    snapshot.forEach((doc) => {
      const p = doc.data();
      postsEl.innerHTML += `
        <div class="post">
          <div class="meta">
            <span class="meta-name">${p.by || "Someone"}</span>
            <span class="meta-time">${p.createdAt?.toDate().toLocaleString() || ""}</span>
          </div>
          <p>${p.body}</p>
        </div>`;
    });
  });
}

loadPosts("general");

// âœ… Switch tabs
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    boardSelect.value = currentBoard;
    loadPosts(currentBoard);
  });
});

import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

postBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  if (!text) return;

  // Wait for Firebase auth to fully load the user
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("You must be logged in.");
      window.netlifyIdentity.open("login"); // auto-open login popup
      return;
    }

    try {
      await addDoc(collection(db, `forum_${boardSelect.value}`), {
        body: text,
        by: user.email || "Anonymous",
        createdAt: serverTimestamp(),
      });

      textarea.value = "";
    } catch (err) {
      console.error("Error posting:", err);
      alert("Could not post message. Try again.");
    }
  });
});

</script>

</body>
</html>

