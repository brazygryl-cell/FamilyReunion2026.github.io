<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Forum — Williams Family Reunion</title>

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>

<body>
  <header></header>

  <main class="section">
    <div class="forum-hero">
      <h1>Family Forum</h1>
      <p>Chat, share memories, and plan the reunion together.</p>
    </div>

    <!-- Forum Tabs -->
    <div class="forum-tabs">
      <button class="forum-tab active" data-board="general">General</button>
      <button class="forum-tab" data-board="memories">Memories</button>
      <button class="forum-tab" data-board="planning">Planning</button>
    </div>

    <!-- Post Composer -->
    <div class="composer card pad">
      <h3>Share something</h3>
      <textarea id="postBody" placeholder="Write your message here..." rows="3"></textarea>
      <div class="row">
        <select id="postBoard">
          <option value="general" selected>General</option>
          <option value="memories">Memories</option>
          <option value="planning">Planning</option>
        </select>
        <button id="submitPost" class="btn mint">Post</button>
      </div>
    </div>

    <!-- Posts Container -->
    <section id="posts" class="posts"></section>
  </main>

  <footer></footer>

  <!-- Scripts -->
  <script type="module" src="./nav.js"></script>
  <script type="module" src="./firebase-init.js"></script>
  <script type="module">
    import { db, auth } from "./firebase-init.js";
    import { collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { loadNavbar, loadFooter } from "./nav.js";

    // Load navbar/footer after DOM ready
    window.addEventListener("DOMContentLoaded", () => {
      loadNavbar();
      loadFooter();
      initForum();
    });

    function initForum() {
      const postsEl = document.getElementById("posts");
      const tabs = document.querySelectorAll(".forum-tab");
      const textarea = document.getElementById("postBody");
      const postBtn = document.getElementById("submitPost");
      const boardSelect = document.getElementById("postBoard");
      let currentBoard = "general";

      // Render posts
      function renderPosts(board) {
        postsEl.innerHTML = `<p style="text-align:center;color:#aaa;">Loading ${board}...</p>`;
        const ref = collection(db, `forum_${board}`);
        const q = query(ref, orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
          postsEl.innerHTML = "";
          if (snapshot.empty) {
            postsEl.innerHTML = `<div class="empty">No posts yet in ${board}.</div>`;
            return;
          }

          snapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "post card pad";
            div.innerHTML = `
              <div class="meta">${data.by || "Anonymous"} • 
                ${data.createdAt?.toDate().toLocaleString() || ""}
              </div>
              <p>${data.body}</p>
            `;
            postsEl.appendChild(div);
          });
        });
      }

      // Switch tabs
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          currentBoard = tab.dataset.board;
          boardSelect.value = currentBoard;
          renderPosts(currentBoard);
        });
      });

      // Create new post
      postBtn.addEventListener("click", async () => {
        const text = textarea.value.trim();
        if (!text) return alert("Write something first!");
        try {
          const ref = collection(db, `forum_${boardSelect.value}`);
          await addDoc(ref, {
            body: text,
            by: auth.currentUser?.email || "Anonymous",
            createdAt: serverTimestamp()
          });
          textarea.value = "";
          renderPosts(boardSelect.value);
        } catch (err) {
          console.error(err);
          alert("Could not post — try again.");
        }
      });

      renderPosts(currentBoard);
    }
  </script>
</body>
</html>
