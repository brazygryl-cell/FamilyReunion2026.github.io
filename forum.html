<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Forum â€” Williams Family Reunion</title>

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <!-- Netlify Identity (login) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Firebase core -->
  <script type="module" src="./firebase-init.js"></script>

  <style>
    .forum-container { max-width: 950px; margin: 2rem auto; padding: 0 16px; }
    .forum-header { text-align: center; margin-bottom: 1.8rem; }
    .forum-header h1 { font-family: "Playfair Display", serif; font-size: 2.3rem; margin: 0; }
    .forum-header p { color: var(--muted); margin-top: 0.4rem; }

    .forum-tabs { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem; }
    .forum-tab { padding: 8px 14px; border-radius: 999px; border: 1px solid var(--border); background: #101420; color: var(--text); cursor: pointer; transition: 0.25s; font-weight: 600; }
    .forum-tab.active { background: var(--mint); color: #0a1310; border-color: var(--mint-2); box-shadow: 0 0 12px rgba(126,224,194,0.25); }

    .composer { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 1.6rem; }
    .composer h3 { margin-top: 0; font-size: 1.2rem; }
    .composer textarea { width: 100%; min-height: 90px; border-radius: 10px; border: 1px solid var(--border); background: #0f121a; color: var(--text); padding: 10px; resize: vertical; }
    .composer .row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
    .composer button { background: var(--mint); border: none; border-radius: 10px; padding: 8px 14px; font-weight: 600; cursor: pointer; color: #0b1311; transition: 0.3s; }
    .composer button:hover { filter: brightness(0.95); }

    .post-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 1rem; box-shadow: var(--shadow); }
    .post-meta { color: var(--muted); font-size: 0.9rem; margin-bottom: 6px; }
    .post-title { font-weight: 700; margin: 0 0 8px; font-size: 1.1rem; }
    .post-body { margin: 0; line-height: 1.55; }

    .reply-section { margin-top: 10px; padding-left: 20px; border-left: 1px solid var(--border); }
    .reply-card { background: #111620; padding: 10px 12px; border-radius: 10px; margin-top: 8px; border: 1px solid var(--border); }
    .reply-meta { font-size: 0.85rem; color: var(--muted); margin-bottom: 4px; }

    .reply-toggle { color: var(--mint); font-size: 0.9rem; cursor: pointer; margin-top: 6px; display: inline-block; }
    .empty { text-align: center; color: var(--muted); padding: 24px 0; }
  </style>
</head>

<body>
  <header></header>

  <main class="forum-container">
    <div class="forum-header">
      <h1>Family Forum</h1>
      <p>Chat, share memories, and plan together for the reunion.</p>
    </div>

    <!-- Tabs -->
    <div class="forum-tabs" role="tablist">
      <button class="forum-tab active" data-board="general">General</button>
      <button class="forum-tab" data-board="memories">Memories</button>
      <button class="forum-tab" data-board="planning">Planning</button>
    </div>

    <!-- Composer -->
    <div class="composer">
      <h3>Create a Post</h3>
      <textarea id="postBody" placeholder="Write something for the familyâ€¦"></textarea>
      <div class="row">
        <select id="postBoard">
          <option value="general">General</option>
          <option value="memories">Memories</option>
          <option value="planning">Planning</option>
        </select>
        <button id="submitPost">Post</button>
      </div>
    </div>

    <!-- Posts -->
    <section id="posts"></section>
  </main>

  <footer></footer>

  <!-- Forum Logic -->
  <script type="module">
    import { db } from "./firebase-init.js";
    import {
      collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const tabs = document.querySelectorAll(".forum-tab");
    const postsEl = document.getElementById("posts");
    const postBodyEl = document.getElementById("postBody");
    const postBoardEl = document.getElementById("postBoard");
    const submitBtn = document.getElementById("submitPost");

    const BOARD_COLLECTIONS = {
      general: "forum_general",
      memories: "forum_memories",
      planning: "forum_planning"
    };

    let currentBoard = "general";
    let unsubscribe = null;

    function renderPost(id, data) {
      const div = document.createElement("div");
      div.className = "post-card";
      div.innerHTML = `
        <div class="post-meta">${data.by || "Anonymous"} â€¢ ${new Date(data.createdAt?.seconds * 1000 || Date.now()).toLocaleString()}</div>
        <h3 class="post-title">${data.title || "New Post"}</h3>
        <p class="post-body">${data.body}</p>
        <div class="reply-toggle" data-id="${id}">ðŸ’¬ Reply</div>
        <div class="reply-section" id="replies-${id}"></div>
      `;
      return div;
    }

    async function subscribePosts(board) {
      if (unsubscribe) unsubscribe();
      postsEl.innerHTML = '<div class="empty">Loading posts...</div>';

      const q = query(collection(db, BOARD_COLLECTIONS[board]), orderBy("createdAt", "desc"));
      unsubscribe = onSnapshot(q, snapshot => {
        postsEl.innerHTML = "";
        if (snapshot.empty) {
          postsEl.innerHTML = '<div class="empty">No posts yet. Be the first!</div>';
          return;
        }
        snapshot.forEach(docSnap => {
          const postDiv = renderPost(docSnap.id, docSnap.data());
          postsEl.appendChild(postDiv);
        });
      });
    }

    submitBtn.addEventListener("click", async () => {
      const text = postBodyEl.value.trim();
      const board = postBoardEl.value;
      if (!text) return;
      await addDoc(collection(db, BOARD_COLLECTIONS[board]), {
        title: null,
        body: text,
        by: window.netlifyIdentity?.currentUser()?.email || "Guest",
        createdAt: serverTimestamp()
      });
      postBodyEl.value = "";
    });

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentBoard = tab.dataset.board;
        postBoardEl.value = currentBoard;
        subscribePosts(currentBoard);
      });
    });

    subscribePosts(currentBoard);
  </script>

  <!-- Nav & Footer -->
  <script type="module">
    import { loadNavbar, enableLogout, requireAuth } from "./nav.js";
    document.addEventListener("DOMContentLoaded", () => {
      loadNavbar();
      enableLogout();
      requireAuth();
    });
  </script>
</body>
</html>


