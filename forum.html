<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Forum</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    #postBody,
    .comment-input { font-size: 1.05rem; line-height: 1.6; }

    .comment-section {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .comment-summary {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      cursor: pointer; padding: 10px 14px; background: #151a22;
      color: var(--text); font-weight: 600; font-size: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .comment-summary:hover { color: var(--mint); }
    .comments-body {
      padding: 12px 14px;
      background: linear-gradient(180deg, #121624 0%, #0f121a 100%);
    }
    .comment {
      background: rgba(255,255,255,0.05);
      border-left: 3px solid var(--mint-2);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      font-size: 1.02rem;
    }
    .comment .byline {
      display: block;
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.95rem;
      font-style: italic;
    }
    .comment-input {
      width: 100%; background: #0f121a; border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 12px; color: var(--text);
      margin-top: 10px;
    }
    .send-comment {
      margin-top: 10px; background: var(--mint); color: #000;
      font-weight: 700; border: none; border-radius: 8px;
      padding: 10px 14px; cursor: pointer;
    }
    .send-comment:hover { filter: brightness(1.1); }
  </style>
</head>

<body>
<header></header>

<section class="section">
  <div class="container">
    <h2>Family Forum</h2>
    <p>Talk, plan, and share updates.</p>

    <!-- Post box -->
    <form id="forumForm" novalidate style="display:none;">
      <input
        type="text"
        id="posterName"
        name="posterName"
        placeholder="Your name (optional)"
        maxlength="40"
        style="
          width:100%; padding:10px 12px; border-radius:8px;
          border:1px solid var(--border); background:#111; color:var(--text);
          margin-bottom:10px; font-size:1.05rem;"
      />
      <textarea id="postBody" name="message" placeholder="Write your message..." required></textarea>
      <button id="submitPost" type="submit">Post</button>
    </form>

    <p id="postStatus" class="status-message"></p>
    <div id="posts">Loading posts...</div>
  </div>
</section>

<footer></footer>

<script src="/env.js"></script>
<script type="module" src="firebase-init.js"></script>

<script type="module">
  import { db } from "./firebase-init.js";
  import {
    collection, addDoc, getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const postsContainer = document.getElementById("posts");
  const statusMessage = document.getElementById("postStatus");
  const form = document.getElementById("forumForm");
  const postField = document.getElementById("postBody");
  const submitButton = document.getElementById("submitPost");
  const postsCol = collection(db, "posts");
  const identity = window.netlifyIdentity;

  function showStatus(message = "", type = "") {
    statusMessage.textContent = message;
    statusMessage.className = `status-message${type ? " " + type : ""}`;
  }

  const displayLabel = (name, itemEmail, currentEmail) => {
    if (name) return name;
    if (itemEmail && currentEmail && itemEmail === currentEmail) return "You";
    return "Family Member";
  };

  async function loadComments(postId, wrapperEl, currentEmail) {
    const commentsCol = collection(db, "posts", postId, "comments");
    const q = query(commentsCol, orderBy("timestamp", "asc"));
    const snap = await getDocs(q);

    const summary = wrapperEl.querySelector(".comment-summary");
    const list = wrapperEl.querySelector(".comments-list");

    const count = snap.size;
    summary.dataset.count = count;
    summary.querySelector(".count").textContent = count;

    list.innerHTML = "";
    snap.forEach(doc => {
      const c = doc.data();
      const el = document.createElement("div");
      el.className = "comment";
      el.innerHTML = `
        <p>${c.message}</p>
        <span class="byline">â€” ${displayLabel(c.name, c.email, currentEmail)}, ${new Date(c.timestamp).toLocaleString()}</span>
      `;
      list.appendChild(el);
    });
  }

  function attachCommentUI(postCardEl, postId, currentUser) {
    const section = document.createElement("div");
    section.className = "comment-section";
    section.innerHTML = `
      <details>
        <summary class="comment-summary">
          <span>ðŸ’¬ Comments</span>
          <span class="count" aria-label="comment count">0</span>
        </summary>
        <div class="comments-body">
          <div class="comments-list"></div>
          <input class="comment-name" type="text" placeholder="Your name (optional)" maxlength="40" style="
            width:100%; background:#0f121a; border:1px solid var(--border);
            border-radius:8px; padding:8px 10px; color:var(--text);
            margin-bottom:8px; font-size:1.02rem;">
          <textarea class="comment-input" placeholder="Add a replyâ€¦"></textarea>
          <button class="send-comment" type="button">Send</button>
        </div>
      </details>
    `;
    postCardEl.appendChild(section);

    const detailsEl = section.querySelector("details");
    const sendBtn = section.querySelector(".send-comment");
    const input = section.querySelector(".comment-input");
    const nameField = section.querySelector(".comment-name");

    let firstOpenLoaded = false;
    detailsEl.addEventListener("toggle", async () => {
      if (detailsEl.open) {
        await loadComments(postId, section, currentUser?.email || "");
        firstOpenLoaded = true;
      }
    });

    sendBtn.addEventListener("click", async () => {
      const message = input.value.trim();
      const name = nameField.value.trim() || "Family Member";
      if (!message) return;

      const commentsCol = collection(db, "posts", postId, "comments");
      try {
        sendBtn.disabled = true;
        await addDoc(commentsCol, {
          name,
          email: currentUser?.email || "anonymous",
          message,
          timestamp: Date.now()
        });
        input.value = "";
        nameField.value = "";
        if (detailsEl.open || !firstOpenLoaded) {
          await loadComments(postId, section, currentUser?.email || "");
        }
      } catch (e) {
        console.error("Failed to add comment:", e);
        showStatus("Could not add comment. Please try again.", "error");
      } finally {
        sendBtn.disabled = false;
      }
    });
  }

  async function loadPosts(currentUser) {
    try {
      const q = query(postsCol, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      postsContainer.innerHTML = snapshot.empty ? "No posts yet." : "";

      snapshot.forEach((doc) => {
        const data = doc.data();
        const postEl = document.createElement("div");
        postEl.className = "post";
        if (data.email === (currentUser?.email || "")) postEl.classList.add("mine");

        postEl.innerHTML = `
          <p>${data.message}</p>
          <span class="meta">â€” ${displayLabel(data.name, data.email, currentUser?.email || "")}, ${new Date(data.timestamp).toLocaleString()}</span>
        `;

        postsContainer.appendChild(postEl);
        attachCommentUI(postEl, doc.id, currentUser);
      });
    } catch (err) {
      console.error("Failed to load posts:", err);
      showStatus(`Could not load posts: ${err.message}`, "error");
    }
  }

  async function postMessage(user) {
    const message = postField.value.trim();
    const nameInput = document.getElementById("posterName");
    const name = nameInput.value.trim() || "Family Member";

    if (!message) {
      showStatus("Please write something before posting.", "info");
      return;
    }

    try {
      submitButton.disabled = true;
      showStatus("Saving your post...", "info");

      await addDoc(postsCol, {
        name,
        email: user.email || "anonymous",
        message,
        timestamp: Date.now(),
      });

      postField.value = "";
      nameInput.value = "";
      showStatus("Post published!", "success");
      await loadPosts(user);
    } catch (err) {
      console.error("Failed to submit post:", err);
      showStatus(`Could not submit your post: ${err.message}`, "error");
    } finally {
      submitButton.disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const handleLogin = (user) => {
      if (user) {
        form.style.display = "block";
        loadPosts(user);
        form.onsubmit = (e) => {
          e.preventDefault();
          postMessage(user);
        };
      } else {
        form.style.display = "none";
        postsContainer.textContent = "Please log in to view and post.";
      }
    };

    identity.on("init", handleLogin);
    identity.on("login", handleLogin);
    identity.on("logout", () => handleLogin(null));
    identity.init();
  });
</script>

<script type="module">
  import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

  document.addEventListener("DOMContentLoaded", () => {
    if (!window.location.pathname.includes("login.html")) requireAuth();
    loadNavbar();
    enableLogout();
  });
</script>

</body>
</html>

