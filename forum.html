<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Forum</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .forum-tab { padding: 10px 16px; border-radius: 6px; cursor: pointer; background:#eee; }
    .forum-tab.active { background:#333; color:white; }

    #posts { max-width:800px; margin:auto; }
    .post { background:white; border-radius:6px; padding:12px; margin-bottom:14px; border:1px solid #ddd; }
    .meta { font-size:0.8em; color:#555; margin-bottom:6px; }

    #postBox { max-width:800px; margin:auto; margin-top:18px; }
    textarea { width:100%; height:120px; padding:10px; border-radius:6px; border:1px solid #ccc; }
    #submitPost { margin-top:10px; padding:8px 14px; }
  </style>

  <!-- ✅ Load Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script type="module" src="nav.js"></script>
</head>
<body>
<header></header>

<section class="section">
  <div class="container">

    <h2>Family Forum</h2>
    <p style="color:#777;margin-bottom:18px;">Talk, plan, and share updates.</p>

    <!-- ✅ Tabs -->
    <div class="tabs-container">
      <button class="forum-tab active" data-topic="general">General</button>
      <button class="forum-tab" data-topic="planning">Planning</button>
    </div>

    <!-- ✅ Posts Container -->
    <div id="posts"></div>

    <!-- ✅ Post Box -->
    <div id="postBox" style="display:none;">
      <textarea id="postBody" placeholder="Write your message..."></textarea>
      <button id="submitPost">Post</button>
    </div>

  </div>
</section>

<footer></footer>

<!-- ✅ Forum Logic -->
<script type="module">
import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  enableLogout();
  requireAuth(); // ✅ Protects this page

  const postsContainer = document.getElementById("posts");
  const postBody = document.getElementById("postBody");
  const submitPost = document.getElementById("submitPost");
  const postBox = document.getElementById("postBox");
  let currentTopic = "general";

  // ✅ If logged in → show posting box
  window.netlifyIdentity.on("init", (user) => {
    if (user) postBox.style.display = "block";
  });
  window.netlifyIdentity.on("login", () => location.reload());
  window.netlifyIdentity.on("logout", () => location.reload());

  // ✅ Load Posts
  async function loadPosts() {
    const res = await fetch("/posts.json");
    const data = await res.json();
    const posts = data[currentTopic] || [];

    postsContainer.innerHTML = posts
      .map(post => `
        <div class="post">
          <div class="meta">${post.author} — ${post.date}</div>
          <div>${post.body}</div>
        </div>
      `).join("");
  }

  // ✅ Switch Tabs
  document.querySelectorAll(".forum-tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelector(".forum-tab.active").classList.remove("active");
      tab.classList.add("active");
      currentTopic = tab.dataset.topic;
      loadPosts();
    });
  });

  // ✅ Submit Post → Netlify Function
  submitPost.addEventListener("click", async () => {
    const user = window.netlifyIdentity.currentUser();
    if (!user) return alert("Log in first.");

    const body = postBody.value.trim();
    if (!body) return;

    await fetch("/.netlify/functions/save-posts", {
      method: "POST",
      body: JSON.stringify({
        topic: currentTopic,
        author: user.user_metadata.full_name || user.email,
        body: body
      })
    });

    postBody.value = "";
    loadPosts();
  });

  loadPosts();
});
</script>

</body>
</html>
