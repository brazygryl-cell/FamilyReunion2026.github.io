<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Forum</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    #posts { max-width:800px; margin:auto; margin-top:20px; }
     .post {
  background: #eef2ff;                /* light lavender bubble */
  border-left: 4px solid #6366f1;     /* accent stripe (blue-purple) */
  border-radius: 6px;
  padding: 12px 16px;
  margin-bottom: 14px;
  color: #1e1e1e;                     /* dark text for readability */
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
.post:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}
.meta {
  font-size: 0.8em;
  color: #4b5563;
  margin-top: 8px;
  display: block;
}

    #postBox { max-width:800px; margin:auto; margin-top:25px; }
    textarea {
      width:100%;
      height:120px;
      padding:10px;
      border-radius:6px;
      border:1px solid #bbb;
      background:white;
      color:black;
      resize: vertical;
    }
    #submitPost {
      margin-top:10px;
      padding:8px 14px;
      border-radius:6px;
      cursor:pointer;
      background:#333;
      color:white;
      border:none;
    }
    .status-message { margin-top:12px; text-align:center; font-size:0.95em; }
    .status-message.error { color:#b00020; }
    .status-message.success { color:#0f5132; }
    .status-message.info { color:#0d6efd; }
  </style>
</head>

<body>
<header></header>

<section class="section">
  <div class="container">
    <h2>Family Forum</h2>
    <p>Talk, plan, and share updates.</p>

    <!-- Post box -->
    <form id="forumForm" novalidate style="display:none;">
      <textarea id="postBody" name="message" placeholder="Write your message..." required></textarea>
      <button id="submitPost" type="submit">Post</button>
    </form>

    <p id="postStatus" class="status-message"></p>
    <div id="posts">Loading posts...</div>
  </div>
</section>

<footer></footer>

<!-- Must be classic script (not module) -->
<script src="/env.js"></script>
<script type="module" src="firebase-init.js"></script>

<!-- Forum Logic -->
<script type="module">
  import { db } from "./firebase-init.js";
  import {
    collection,
    addDoc,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const postsContainer = document.getElementById("posts");
  const statusMessage = document.getElementById("postStatus");
  const form = document.getElementById("forumForm");
  const postField = document.getElementById("postBody");
  const submitButton = document.getElementById("submitPost");
  const postsCol = collection(db, "posts");

  function showStatus(message = "", type = "") {
    statusMessage.textContent = message;
    statusMessage.className = `status-message${type ? " " + type : ""}`;
  }

  async function loadPosts() {
    try {
      const q = query(postsCol, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      postsContainer.innerHTML = snapshot.empty ? "No posts yet." : "";

      snapshot.forEach((doc) => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <p>${data.message}</p>
          <span class="meta">â€” ${data.email || "unknown"}, ${new Date(data.timestamp).toLocaleString()}</span>
        `;
        postsContainer.appendChild(div);
      });
    } catch (err) {
      console.error("Failed to load posts:", err);
      showStatus(`Could not load posts: ${err.message}`, "error");
    }
  }

  async function postMessage(user) {
    const message = postField.value.trim();
    if (!message) {
      showStatus("Please write something before posting.", "info");
      return;
    }

    try {
      submitButton.disabled = true;
      showStatus("Saving your post...", "info");

      await addDoc(postsCol, {
        email: user.email || "anonymous",
        message,
        timestamp: Date.now(),
      });

      postField.value = "";
      showStatus("Post published!", "success");
      loadPosts();
    } catch (err) {
      console.error("Failed to submit post:", err);
      showStatus(`Could not submit your post: ${err.message}`, "error");
    } finally {
      submitButton.disabled = false;
    }
  }

  // --- Auth-aware behavior ---
  document.addEventListener("DOMContentLoaded", () => {
    const identity = window.netlifyIdentity;

    const handleLogin = (user) => {
      if (user) {
        form.style.display = "block";
        loadPosts();
        form.onsubmit = (e) => {
          e.preventDefault();
          postMessage(user);
        };
      } else {
        form.style.display = "none";
        postsContainer.textContent = "Please log in to view and post.";
      }
    };

    identity.on("init", handleLogin);
    identity.on("login", handleLogin);
    identity.on("logout", () => handleLogin(null));
    identity.init();
  });
</script>

<!-- Navbar / Auth Gate -->
<script type="module">
  import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

  document.addEventListener("DOMContentLoaded", () => {
    if (!window.location.pathname.includes("login.html")) {
      requireAuth();
    }
    loadNavbar();
    enableLogout();
  });
</script>

</body>
</html>
