<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Forum â€” Williams Family Reunion</title>

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
/* ðŸŒ™ Discord-Inspired Forum Styling */
.tabs-container {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 1.5rem;
}
.forum-tab {
  padding: 8px 16px;
  background: #232428;
  border: 1px solid #3a3c42;
  border-radius: 8px;
  cursor: pointer;
  color: #cfcfcf;
  font-weight: 500;
  transition: 0.2s;
}
.forum-tab.active, .forum-tab:hover {
  background: #5865F2;
  border-color: #5865F2;
  color: white;
}
#posts { max-width: 750px; margin: 1rem auto; padding: 1rem; }
.post {
  background: #2b2d31; border: 1px solid #3a3c42;
  border-radius: 10px; padding: 14px 18px; margin-bottom: 14px;
}
.meta {
  font-size: 0.85rem; color: #9ca3af;
  margin-bottom: 6px; display: flex; justify-content: space-between;
}
#postBox {
  max-width: 750px; margin: 2rem auto; padding: 1rem;
  background: #1e1f22; border: 1px solid #3a3c42; border-radius: 12px;
}
#postBody {
  width: 100%; background: #2b2d31; border: 1px solid #3a3c42;
  padding: 12px; color: white; min-height: 80px; border-radius: 8px;
}
#submitPost {
  width: 100%; background: #5865F2; border: none; padding: 12px;
  color: white; cursor: pointer; border-radius: 8px; margin-top: 8px; font-weight: 600;
}
#submitPost:hover { background: #4752C4; }
</style>
</head>

<body>
<header></header>

<h2 style="text-align:center;margin-top:1.5rem;">Family Forum ðŸ’¬</h2>

<div class="tabs-container">
  <div class="forum-tab active" data-board="general">General</div>
  <div class="forum-tab" data-board="memories">Memories</div>
  <div class="forum-tab" data-board="planning">Planning</div>
</div>

<div id="posts"></div>

<div id="postBox">
  <select id="postBoard">
    <option value="general">General</option>
    <option value="memories">Memories</option>
    <option value="planning">Planning</option>
  </select>
  <textarea id="postBody" placeholder="Say something..."></textarea>
  <button id="submitPost">Post</button>
</div>

<footer></footer>

<!-- âœ… Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- âœ… Public Firebase Config Loader -->
<script src="env.js"></script>
<script type="module" src="firebase-config.public.js"></script>

<!-- âœ… Forum Logic -->
<script type="module">
import { loadNavbar, enableLogout, requireAuth } from "./nav.js";
import getFirebaseConfig from "./firebase-config.public.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

document.addEventListener("DOMContentLoaded", async () => {
  loadNavbar();
  enableLogout();
  requireAuth();

  // âœ… Wait for Netlify login, then sign Firebase in before loading posts
  window.netlifyIdentity.on("init", async (user) => {
    if (user) {
      const token = await user.jwt();
      await signInWithCustomToken(auth, token).catch(console.error);
    }
    loadPosts(currentBoard); // âœ… ensure posts load **after** auth is synced
  });

  window.netlifyIdentity.on("login", async (user) => {
    const token = await user.jwt();
    await signInWithCustomToken(auth, token).catch(console.error);
    loadPosts(currentBoard);
  });
});


const firebaseConfig = getFirebaseConfig();
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// UI Elements
const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const boardSelect = document.getElementById("postBoard");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

// âœ… Load posts live
function loadPosts(board) {
  postsEl.innerHTML = `<p style="text-align:center;color:#bbb;">Loading...</p>`;
  const q = query(collection(db, `forum_${board}`), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    postsEl.innerHTML = "";
    if (snapshot.empty) return postsEl.innerHTML = `<p style="text-align:center;color:#777;">No posts yet.</p>`;
    snapshot.forEach((doc) => {
      const p = doc.data();
      postsEl.innerHTML += `
        <div class="post">
          <div class="meta">
            <span>${p.by || "Someone"}</span>
            <span>${p.createdAt?.toDate().toLocaleString() || ""}</span>
          </div>
          <p>${p.body}</p>
        </div>`;
    });
  });
}

loadPosts("general");

// âœ… Switch tabs
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    boardSelect.value = currentBoard;
    loadPosts(currentBoard);
  });
});

// âœ… Post Messages (with synced auth)
postBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  if (!text) return;

  const netlifyUser = window.netlifyIdentity.currentUser();
  if (!netlifyUser) return window.netlifyIdentity.open("login");

  const token = await netlifyUser.jwt();
  await signInWithCustomToken(auth, token).catch(console.error);

  await new Promise(r => setTimeout(r, 300)); // <-- ensures Firebase sees auth

  await addDoc(collection(db, `forum_${boardSelect.value}`), {
    body: text,
    by: netlifyUser.email,
    createdAt: serverTimestamp(),
  });

  textarea.value = "";
});
</script>

</body>
</html>

