<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Forum</title>

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet"/>

  <!-- âœ… Navbar + Auth Protection -->
  <script type="module">
    import { loadNavbar, enableLogout, requireAuthFirebase } from "./nav.js";

    document.addEventListener("DOMContentLoaded", () => {
      requireAuthFirebase();   // redirect to login if not signed in
      loadNavbar();
      enableLogout();
    });
  </script>

  <style>
    #postBody, .comment-input { font-size: 1.05rem; line-height: 1.6; }

    .comment-section {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      overflow: hidden;
    }
    .comment-summary {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      cursor: pointer; padding: 10px 14px; background: #151a22;
      color: var(--text); font-weight: 600; font-size: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .comment-summary:hover { color: var(--mint); }
    .comments-body {
      padding: 12px 14px;
      background: linear-gradient(180deg, #121624 0%, #0f121a 100%);
    }
    .comment {
      background: rgba(255,255,255,0.05);
      border-left: 3px solid var(--mint-2);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      font-size: 1.02rem;
    }
    .comment .byline {
      display: block;
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.95rem;
      font-style: italic;
    }
    .comment-input {
      width: 100%; background: #0f121a; border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 12px; color: var(--text);
      margin-top: 10px;
    }
    .send-comment {
      margin-top: 10px; background: var(--mint); color: #000;
      font-weight: 700; border: none; border-radius: 8px;
      padding: 10px 14px; cursor: pointer;
    }
    .send-comment:hover { filter: brightness(1.1); }

    #forum-hero {
      position: relative;
      height: 300px;
      overflow: hidden;
      border-radius: 0 0 40px 40px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      margin-bottom: 30px;
    }
    #forum-hero .slide {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0;
      transform: scale(1.05);
      transition: opacity 2s ease-in-out, transform 6s ease-in-out;
    }
    #forum-hero .slide.active { opacity: 1; transform: scale(1); }

    #forum-hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1;
    }

    #forum-hero .overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
      z-index: 2;
      max-width: 800px;
    }

    #forum-hero h1 {
      font-family: "Playfair Display", serif;
      font-size: 2.4rem;
      margin-bottom: 0.3rem;
    }

    #forum-hero p {
      color: #d0d6e0;
      font-size: 1.1rem;
    }
  </style>
</head>

<body>
<header></header>

<!-- ðŸŽžï¸ Family Slideshow Hero -->
<section id="forum-hero">
  <div class="slide active" style="background-image:url('images/family1.jpg')"></div>
  <div class="slide" style="background-image:url('images/family2.jpg')"></div>
  <div class="slide" style="background-image:url('images/family3.jpg')"></div>
  <div class="overlay">
    <h1>Family Forum</h1>
    <p>Share memories, updates, and love â€” all in one place ðŸ’¬</p>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2>Family Forum</h2>
    <p>Talk, plan, and share updates.</p>

    <!-- Post form -->
    <form id="forumForm" novalidate style="display:none;">
      <input
        type="text"
        id="posterName"
        name="posterName"
        placeholder="Your name (optional)"
        maxlength="40"
        style="width:100%; padding:10px 12px; border-radius:8px;
          border:1px solid var(--border); background:#111; color:var(--text);
          margin-bottom:10px; font-size:1.05rem;"
      />
      <textarea id="postBody" name="message" placeholder="Write your message..." required></textarea>
      <button id="submitPost" type="submit">Post</button>
    </form>

    <p id="postStatus" class="status-message"></p>
    <div id="posts">Loading posts...</div>
  </div>
</section>

<footer></footer>

<!-- âœ… Firebase forum logic -->
<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { collection, addDoc, getDocs, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const postsContainer = document.getElementById("posts");
  const statusMessage = document.getElementById("postStatus");
  const form = document.getElementById("forumForm");
  const postField = document.getElementById("postBody");
  const submitButton = document.getElementById("submitPost");
  const postsCol = collection(db, "posts");

  function showStatus(message = "", type = "") {
    statusMessage.textContent = message;
    statusMessage.className = `status-message${type ? " " + type : ""}`;
  }

  async function loadPosts(user) {
    try {
      const q = query(postsCol, orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      postsContainer.innerHTML = snapshot.empty ? "No posts yet." : "";

      snapshot.forEach((doc) => {
        const data = doc.data();
        const postEl = document.createElement("div");
        postEl.className = "post";
        postEl.innerHTML = `
          <p>${data.message}</p>
          <span class="meta">â€” ${data.name || "Family Member"}, ${new Date(data.timestamp).toLocaleString()}</span>
        `;
        postsContainer.appendChild(postEl);
      });
    } catch (err) {
      console.error("Failed to load posts:", err);
      showStatus(`Could not load posts: ${err.message}`, "error");
    }
  }

  async function postMessage(user) {
    const message = postField.value.trim();
    const nameInput = document.getElementById("posterName");
    const name = nameInput.value.trim() || "Family Member";

    if (!message) {
      showStatus("Please write something before posting.", "info");
      return;
    }

    try {
      submitButton.disabled = true;
      showStatus("Saving your post...", "info");

      await addDoc(postsCol, {
        name,
        email: user.email || "anonymous",
        message,
        timestamp: Date.now(),
      });

      postField.value = "";
      nameInput.value = "";
      showStatus("Post published!", "success");
      await loadPosts(user);
    } catch (err) {
      console.error("Failed to submit post:", err);
      showStatus(`Could not submit your post: ${err.message}`, "error");
    } finally {
      submitButton.disabled = false;
    }
  }

  // âœ… Firebase Auth listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      form.style.display = "block";
      loadPosts(user);
      form.onsubmit = (e) => {
        e.preventDefault();
        postMessage(user);
      };
    } else {
      form.style.display = "none";
      postsContainer.textContent = "Please log in to view and post.";
    }
  });
</script>

<!-- ðŸŽžï¸ Forum Slideshow -->
<script>
const heroSlides = document.querySelectorAll("#forum-hero .slide");
let heroIndex = 0;
setInterval(() => {
  heroSlides[heroIndex].classList.remove("active");
  heroIndex = (heroIndex + 1) % heroSlides.length;
  heroSlides[heroIndex].classList.add("active");
}, 6000);
</script>

<!-- âœ… External forum logic -->
<script type="module" src="forum.js"></script>

  
</body>
</html>
