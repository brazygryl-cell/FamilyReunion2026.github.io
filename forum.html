<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Forum — Williams Reunion</title>

<!-- netlify-vite --> <!-- ✅ Enables env variable loading -->

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>

<body>
<header></header>

<section class="forum container">
  <h2 style="text-align:center;">Family Forum</h2>

  <!-- Tabs -->
  <div class="forum-tabs">
    <button class="forum-tab active" data-board="general">General</button>
    <button class="forum-tab" data-board="memories">Memories</button>
    <button class="forum-tab" data-board="planning">Planning</button>
  </div>

  <!-- Posts -->
  <div id="posts" class="posts"></div>

  <!-- Post Box -->
  <div class="post-box">
    <select id="postBoard">
      <option value="general">General</option>
      <option value="memories">Memories</option>
      <option value="planning">Planning</option>
    </select>

    <textarea id="postBody" placeholder="Write something to your family..."></textarea>
    <button id="submitPost" class="btn mint">Post</button>
  </div>
</section>

<footer></footer>

<!-- 🔐 Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script type="module">
  import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

  document.addEventListener("DOMContentLoaded", () => {
    loadNavbar();
    enableLogout();
    requireAuth();
  });
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,   // ✅ Secure — key comes from Netlify
  authDomain: "williams-reunion.firebaseapp.com",
  projectId: "williams-reunion"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

import { signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

// Sync Netlify Identity → Firebase Auth
if (window.netlifyIdentity) {
  window.netlifyIdentity.on("login", async (user) => {
    const token = await user.jwt(true);
    const res = await fetch("/.netlify/functions/firebase-token", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` }
    });
    const { customToken } = await res.json();
    await signInWithCustomToken(auth, customToken);
  });
}


// ---- UI elements ----
const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const boardSelect = document.getElementById("postBoard");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

// ✅ Load posts from Firestore (live)
function loadPosts(board) {
  postsEl.innerHTML = `<p style="color:#aaa;text-align:center;">Loading...</p>`;

  const ref = collection(db, `forum_${board}`);
  const q = query(ref, orderBy("createdAt", "desc"));

  onSnapshot(q, (snapshot) => {
    postsEl.innerHTML = "";
    if (snapshot.empty) return postsEl.innerHTML = `<p>No posts yet.</p>`;

    snapshot.forEach((doc) => {
      const p = doc.data();
      postsEl.innerHTML += `
        <div class="post">
          <div class="meta">${p.by || "Unknown"} • ${p.createdAt?.toDate().toLocaleString() || ""}</div>
          <p>${p.body}</p>
        </div>
      `;
    });
  });
}

// ✅ Switch tabs
tabs.forEach((tab) => {
  tab.addEventListener("click", () => {
    tabs.forEach((t) => t.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    boardSelect.value = currentBoard;
    loadPosts(currentBoard);
  });
});

// ✅ Create post
postBtn.addEventListener("click", async () => {
  const text = textarea.value.trim();
  const user = auth.currentUser;
  if (!user) return alert("Please log in.");
  if (!text) return;

  await addDoc(collection(db, `forum_${boardSelect.value}`), {
    body: text,
    by: user.email,
    createdAt: serverTimestamp(),
  });

  textarea.value = "";
});

// ✅ Wait for login before loading posts
onAuthStateChanged(auth, (user) => {
  if (user) loadPosts(currentBoard);
});
</script>

</body>
</html>

