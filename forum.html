<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Forum â€” Williams Family Reunion</title>

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

<style>
.tabs-container { display:flex; gap:10px; justify-content:center; margin-top:1.5rem; }
.forum-tab { padding:8px 16px; background:#232428; border:1px solid #3a3c42; border-radius:8px; cursor:pointer; color:#cfcfcf; font-weight:500; transition:0.2s; }
.forum-tab.active, .forum-tab:hover { background:#5865F2; border-color:#5865F2; color:white; }

#posts { max-width:750px; margin:1rem auto; padding:1rem; }
.post { background:#2b2d31; border:1px solid #3a3c42; border-radius:10px; padding:14px 18px; margin-bottom:14px; }
.meta { font-size:0.85rem; color:#9ca3af; margin-bottom:6px; display:flex; justify-content:space-between; }

#postBox { max-width:750px; margin:2rem auto; padding:1rem; background:#1e1f22; border:1px solid #3a3c42; border-radius:12px; }
#postBody { width:100%; background:#2b2d31; border:1px solid #3a3c42; padding:12px; color:white; min-height:80px; border-radius:8px; resize:vertical; }
#submitPost { width:100%; background:#5865F2; border:none; padding:12px; color:white; cursor:pointer; border-radius:8px; margin-top:8px; font-weight:600; }
#submitPost:hover { background:#4752C4; }
</style>
</head>

<body>

  <script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user && !window.location.pathname.includes("login.html")) {
        window.location.href = "login.html";
      }
    });
  }
</script>
  
<header></header>

<h2 style="text-align:center;margin-top:1.5rem;">Family Forum ðŸ’¬</h2>

<div class="tabs-container">
  <div class="forum-tab active" data-board="general">General</div>
  <div class="forum-tab" data-board="planning">Planning</div>
</div>

<div id="posts"></div>

<div id="postBox">
  <textarea id="postBody" placeholder="Say something..."></textarea>
  <button id="submitPost">Post</button>
</div>

<footer></footer>

<!-- Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script type="module">
import { loadNavbar, enableLogout, requireAuth } from "./nav.js";

document.addEventListener("DOMContentLoaded", () => {
  loadNavbar();
  enableLogout();
  requireAuth();
});

/* --------- CONFIG -------- */
const repoOwner = "FamilyReunion2026";
const repoName = "FamilyReunion2026.github.io";
const filePath = "posts.json";

/* --------- UI -------- */
const postsEl = document.getElementById("posts");
const tabs = document.querySelectorAll(".forum-tab");
const textarea = document.getElementById("postBody");
const postBtn = document.getElementById("submitPost");

let currentBoard = "general";

/* --------- Load Posts -------- */
async function loadPosts() {
  const res = await fetch(`https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}?v=${Date.now()}`);
  const data = await res.json();
  const boardPosts = data[currentBoard] || [];

  postsEl.innerHTML = boardPosts.length ? "" : `<p style="text-align:center;color:#777;">No posts yet.</p>`;

  boardPosts.slice().reverse().forEach(p => {
    postsEl.innerHTML += `
      <div class="post">
        <div class="meta">
          <span>${p.by}</span>
          <span>${p.time}</span>
        </div>
        <p>${p.body}</p>
      </div>`;
  });
}

/* --------- Save Post to GitHub -------- */
async function savePost(body) {
  const user = window.netlifyIdentity.currentUser();
  if (!user) return window.netlifyIdentity.open("login");

  const token = (await user.jwt()).token;

  const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const json = await res.json();
  const content = atob(json.content);
  const data = JSON.parse(content);

  data[currentBoard].push({
    by: user.email,
    body,
    time: new Date().toLocaleString()
  });

  await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${token}` },
    body: JSON.stringify({
      message: "New forum post",
      content: btoa(JSON.stringify(data, null, 2)),
      sha: json.sha
    })
  });

  textarea.value = "";
  loadPosts();
}

/* --------- Events -------- */
tabs.forEach(tab => {
  tab.addEventListener("click", () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");
    currentBoard = tab.dataset.board;
    loadPosts();
  });
});

postBtn.addEventListener("click", () => {
  const text = textarea.value.trim();
  if (text) savePost(text);
});

loadPosts();
</script>

  <script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user && !window.location.pathname.includes("login.html")) {
        window.location.href = "login.html";
      }
    });
  }
</script>

</body>
</html>

