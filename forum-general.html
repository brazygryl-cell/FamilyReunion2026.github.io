<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forum - General - Williams Family Reunion</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>General Discussion</h1>
<nav class="forum-nav">
  <a href="forum-general.html">General</a> |
  <a href="forum-memories.html">Memories</a> |
  <a href="forum-pictures.html">Pictures</a> |
  <a href="forum-planning.html">Planning</a>
</nav>

<button id="logout">Logout</button>
<div id="messages"></div>

<form id="message-form">
  <textarea id="message" placeholder="Write a message..." required></textarea>
  <button type="submit">Post</button>
</form>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script type="module" src="firebase-init.js"></script>
<script type="module">
import { auth, db } from './firebase-init.js';

// Login + approval check
auth.onAuthStateChanged(async user=>{
  if(!user){window.location.href="login.html";return;}
  const doc=await db.collection('approvedUsers').doc(user.email).get();
  if(!doc.exists||!doc.data().approved){await auth.signOut();alert("Not approved.");window.location.href="login.html";}
});

// Logout
document.getElementById('logout').addEventListener('click',async()=>{await auth.signOut();window.location.href="login.html";});

// Message posting
const messageForm=document.getElementById('message-form');
messageForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const text=document.getElementById('message').value;
  const user=auth.currentUser;
  if(user){
    await db.collection('forumMessages').add({
      text,
      user:user.email,
      board: 'general', // <-- IMPORTANT: assign this board
      timestamp:new Date()
    });
    document.getElementById('message').value='';
  }
});

// Display messages for this board only
db.collection('forumMessages').where('board','==','general').orderBy('timestamp')
.onSnapshot(snapshot=>{
  const container=document.getElementById('messages');
  container.innerHTML='';
  snapshot.forEach(doc=>{
    const msg=doc.data();
    const div=document.createElement('div');
    div.textContent=`${msg.user}: ${msg.text}`;
    container.appendChild(div);
  });
});
</script>
</body>
</html>
