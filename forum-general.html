<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum - General - Williams Family Reunion</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>General Discussion</h1>
  <nav class="forum-nav">
    <a href="forum-general.html">General</a> |
    <a href="forum-memories.html">Memories</a> |
    <a href="forum-planning.html">Planning</a>
  </nav>

  <button id="logout">Logout</button>

  <div id="messages" class="forum-messages"></div>

  <form id="message-form">
    <textarea id="message" placeholder="Write a message..." required></textarea>
    <button type="submit">Post</button>
  </form>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>

  <script>
    // ðŸ”’ Auth + approval check
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const doc = await db.collection('approvedUsers').doc(user.email).get();
      if (!doc.exists || !doc.data().approved) {
        await auth.signOut();
        alert("Not approved yet â€” please wait for admin approval.");
        window.location.href = "login.html";
      }
    });

    // ðŸšª Logout
    document.getElementById('logout').addEventListener('click', async () => {
      await auth.signOut();
      window.location.href = "login.html";
    });

    // ðŸ’¬ Post message
    const messageForm = document.getElementById('message-form');
    messageForm.addEventListener('submit', async e => {
      e.preventDefault();
      const text = document.getElementById('message').value.trim();
      const user = auth.currentUser;
      if (text && user) {
        await db.collection('forumMessages').add({
          text,
          user: user.email,
          board: 'general', // ðŸ‘ˆ identifies the board
          timestamp: new Date()
        });
        document.getElementById('message').value = '';
      }
    });

    // ðŸ§¾ Display messages for this board only
    db.collection('forumMessages')
      .where('board', '==', 'general')
      .orderBy('timestamp', 'asc')
      .onSnapshot(snapshot => {
        const container = document.getElementById('messages');
        container.innerHTML = '';

        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.classList.add('message-card');

          const userEl = document.createElement('span');
          userEl.classList.add('msg-user');
          userEl.textContent = msg.user;

          const timeEl = document.createElement('span');
          timeEl.classList.add('msg-time');
          const date = msg.timestamp?.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
          timeEl.textContent = ` â€¢ ${date.toLocaleString()}`;

          const textEl = document.createElement('p');
          textEl.classList.add('msg-text');
          textEl.textContent = msg.text;

          div.appendChild(userEl);
          div.appendChild(timeEl);
          div.appendChild(textEl);
          container.appendChild(div);
        });
      });
  </script>

</body>
</html>
